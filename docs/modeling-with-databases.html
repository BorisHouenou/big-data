<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Modeling with databases | _main.utf8.md</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Modeling with databases | _main.utf8.md" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Modeling with databases | _main.utf8.md" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-visualizations.html"/>
<link rel="next" href="advanced-operations.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Big Data with R - Exercise book</a></li>
<li class="chapter" data-level="1" data-path="introduction-to-vroom.html"><a href="introduction-to-vroom.html"><i class="fa fa-check"></i><b>1</b> Introduction to <code>vroom</code></a><ul>
<li class="chapter" data-level="1.1" data-path="introduction-to-vroom.html"><a href="introduction-to-vroom.html#vroom-basics"><i class="fa fa-check"></i><b>1.1</b> <code>vroom</code> basics</a></li>
<li class="chapter" data-level="1.2" data-path="introduction-to-vroom.html"><a href="introduction-to-vroom.html#load-multiple-files"><i class="fa fa-check"></i><b>1.2</b> Load multiple files</a></li>
<li class="chapter" data-level="1.3" data-path="introduction-to-vroom.html"><a href="introduction-to-vroom.html#load-and-modify-multiple-files"><i class="fa fa-check"></i><b>1.3</b> Load and modify multiple files</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html"><i class="fa fa-check"></i><b>2</b> Introduction to <code>dtplyr</code></a><ul>
<li class="chapter" data-level="2.1" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html#dtplyr-basics"><i class="fa fa-check"></i><b>2.1</b> <code>dtplyr</code> basics</a></li>
<li class="chapter" data-level="2.2" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html#object-sizes"><i class="fa fa-check"></i><b>2.2</b> Object sizes</a></li>
<li class="chapter" data-level="2.3" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html#how-dtplyr-works"><i class="fa fa-check"></i><b>2.3</b> How <code>dtplyr</code> works</a></li>
<li class="chapter" data-level="2.4" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html#working-with-dtplyr"><i class="fa fa-check"></i><b>2.4</b> Working with <code>dtplyr</code></a></li>
<li class="chapter" data-level="2.5" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html#pivot-data"><i class="fa fa-check"></i><b>2.5</b> Pivot data</a></li>
<li class="chapter" data-level="2.6" data-path="introduction-to-dtplyr.html"><a href="introduction-to-dtplyr.html#the-mutate-verb"><i class="fa fa-check"></i><b>2.6</b> The <code>mutate()</code> verb</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduction-to-database-connections.html"><a href="introduction-to-database-connections.html"><i class="fa fa-check"></i><b>3</b> Introduction to database connections</a><ul>
<li class="chapter" data-level="3.1" data-path="introduction-to-database-connections.html"><a href="introduction-to-database-connections.html#connecting-via-dsn"><i class="fa fa-check"></i><b>3.1</b> Connecting via DSN</a></li>
<li class="chapter" data-level="3.2" data-path="introduction-to-database-connections.html"><a href="introduction-to-database-connections.html#connect-with-a-connection-string"><i class="fa fa-check"></i><b>3.2</b> Connect with a connection string</a></li>
<li class="chapter" data-level="3.3" data-path="introduction-to-database-connections.html"><a href="introduction-to-database-connections.html#secure-connection-details"><i class="fa fa-check"></i><b>3.3</b> Secure connection details</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="introduction-to-dbi.html"><a href="introduction-to-dbi.html"><i class="fa fa-check"></i><b>4</b> Introduction to <code>DBI</code></a><ul>
<li class="chapter" data-level="4.1" data-path="introduction-to-dbi.html"><a href="introduction-to-dbi.html#local-database-basics"><i class="fa fa-check"></i><b>4.1</b> Local database basics</a></li>
<li class="chapter" data-level="4.2" data-path="introduction-to-dbi.html"><a href="introduction-to-dbi.html#options-for-writing-tables"><i class="fa fa-check"></i><b>4.2</b> Options for writing tables</a></li>
<li class="chapter" data-level="4.3" data-path="introduction-to-dbi.html"><a href="introduction-to-dbi.html#database-operations"><i class="fa fa-check"></i><b>4.3</b> Database operations</a></li>
<li class="chapter" data-level="4.4" data-path="introduction-to-dbi.html"><a href="introduction-to-dbi.html#knitr-sql-engine"><i class="fa fa-check"></i><b>4.4</b> <code>knitr</code> SQL engine</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="databases-and-dplyr.html"><a href="databases-and-dplyr.html"><i class="fa fa-check"></i><b>5</b> Databases and <code>dplyr</code></a><ul>
<li class="chapter" data-level="5.1" data-path="databases-and-dplyr.html"><a href="databases-and-dplyr.html#intro-to-connections"><i class="fa fa-check"></i><b>5.1</b> Intro to <code>connections</code></a></li>
<li class="chapter" data-level="5.2" data-path="databases-and-dplyr.html"><a href="databases-and-dplyr.html#table-reference"><i class="fa fa-check"></i><b>5.2</b> Table reference</a></li>
<li class="chapter" data-level="5.3" data-path="databases-and-dplyr.html"><a href="databases-and-dplyr.html#under-the-hood"><i class="fa fa-check"></i><b>5.3</b> Under the hood</a></li>
<li class="chapter" data-level="5.4" data-path="databases-and-dplyr.html"><a href="databases-and-dplyr.html#un-translated-r-commands"><i class="fa fa-check"></i><b>5.4</b> Un-translated R commands</a></li>
<li class="chapter" data-level="5.5" data-path="databases-and-dplyr.html"><a href="databases-and-dplyr.html#using-bang-bang"><i class="fa fa-check"></i><b>5.5</b> Using bang-bang</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-visualizations.html"><a href="data-visualizations.html"><i class="fa fa-check"></i><b>6</b> Data Visualizations</a><ul>
<li class="chapter" data-level="6.1" data-path="data-visualizations.html"><a href="data-visualizations.html#simple-plot"><i class="fa fa-check"></i><b>6.1</b> Simple plot</a></li>
<li class="chapter" data-level="6.2" data-path="data-visualizations.html"><a href="data-visualizations.html#plot-in-one-code-segment"><i class="fa fa-check"></i><b>6.2</b> Plot in one code segment</a></li>
<li class="chapter" data-level="6.3" data-path="data-visualizations.html"><a href="data-visualizations.html#create-a-histogram"><i class="fa fa-check"></i><b>6.3</b> Create a histogram</a></li>
<li class="chapter" data-level="6.4" data-path="data-visualizations.html"><a href="data-visualizations.html#raster-plot"><i class="fa fa-check"></i><b>6.4</b> Raster plot</a></li>
<li class="chapter" data-level="6.5" data-path="data-visualizations.html"><a href="data-visualizations.html#using-the-compute-functions"><i class="fa fa-check"></i><b>6.5</b> Using the <code>compute</code> functions</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="modeling-with-databases.html"><a href="modeling-with-databases.html"><i class="fa fa-check"></i><b>7</b> Modeling with databases</a><ul>
<li class="chapter" data-level="7.1" data-path="modeling-with-databases.html"><a href="modeling-with-databases.html#single-step-sampling"><i class="fa fa-check"></i><b>7.1</b> Single step sampling</a></li>
<li class="chapter" data-level="7.2" data-path="modeling-with-databases.html"><a href="modeling-with-databases.html#using-tidymodels-for-modeling"><i class="fa fa-check"></i><b>7.2</b> Using <code>tidymodels</code> for modeling</a></li>
<li class="chapter" data-level="7.3" data-path="modeling-with-databases.html"><a href="modeling-with-databases.html#score-with-tidypredict"><i class="fa fa-check"></i><b>7.3</b> Score with <code>tidypredict</code></a></li>
<li class="chapter" data-level="7.4" data-path="modeling-with-databases.html"><a href="modeling-with-databases.html#run-predictions-in-db"><i class="fa fa-check"></i><b>7.4</b> Run predictions in DB</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="advanced-operations.html"><a href="advanced-operations.html"><i class="fa fa-check"></i><b>8</b> Advanced Operations</a><ul>
<li class="chapter" data-level="8.1" data-path="advanced-operations.html"><a href="advanced-operations.html#simple-wrapper-function"><i class="fa fa-check"></i><b>8.1</b> Simple wrapper function</a></li>
<li class="chapter" data-level="8.2" data-path="advanced-operations.html"><a href="advanced-operations.html#multiple-variables"><i class="fa fa-check"></i><b>8.2</b> Multiple variables</a></li>
<li class="chapter" data-level="8.3" data-path="advanced-operations.html"><a href="advanced-operations.html#multiple-queries"><i class="fa fa-check"></i><b>8.3</b> Multiple queries</a></li>
<li class="chapter" data-level="8.4" data-path="advanced-operations.html"><a href="advanced-operations.html#multiple-queries-with-an-overlapping-range"><i class="fa fa-check"></i><b>8.4</b> Multiple queries with an overlapping range</a></li>
<li class="chapter" data-level="8.5" data-path="advanced-operations.html"><a href="advanced-operations.html#characters-to-field-names"><i class="fa fa-check"></i><b>8.5</b> Characters to field names</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="intro-to-sparklyr.html"><a href="intro-to-sparklyr.html"><i class="fa fa-check"></i><b>9</b> Intro to <code>sparklyr</code></a><ul>
<li class="chapter" data-level="9.1" data-path="intro-to-sparklyr.html"><a href="intro-to-sparklyr.html#new-spark-session"><i class="fa fa-check"></i><b>9.1</b> New Spark session</a></li>
<li class="chapter" data-level="9.2" data-path="intro-to-sparklyr.html"><a href="intro-to-sparklyr.html#data-transfer"><i class="fa fa-check"></i><b>9.2</b> Data transfer</a></li>
<li class="chapter" data-level="9.3" data-path="intro-to-sparklyr.html"><a href="intro-to-sparklyr.html#spark-and-dplyr"><i class="fa fa-check"></i><b>9.3</b> Spark and <code>dplyr</code></a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="text-mining-with-sparklyr.html"><a href="text-mining-with-sparklyr.html"><i class="fa fa-check"></i><b>10</b> Text mining with <code>sparklyr</code></a><ul>
<li class="chapter" data-level="10.1" data-path="text-mining-with-sparklyr.html"><a href="text-mining-with-sparklyr.html#data-import"><i class="fa fa-check"></i><b>10.1</b> Data Import</a></li>
<li class="chapter" data-level="10.2" data-path="text-mining-with-sparklyr.html"><a href="text-mining-with-sparklyr.html#tidying-data"><i class="fa fa-check"></i><b>10.2</b> Tidying data</a></li>
<li class="chapter" data-level="10.3" data-path="text-mining-with-sparklyr.html"><a href="text-mining-with-sparklyr.html#transform-the-data"><i class="fa fa-check"></i><b>10.3</b> Transform the data</a></li>
<li class="chapter" data-level="10.4" data-path="text-mining-with-sparklyr.html"><a href="text-mining-with-sparklyr.html#data-exploration"><i class="fa fa-check"></i><b>10.4</b> Data Exploration</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="spark-data-caching.html"><a href="spark-data-caching.html"><i class="fa fa-check"></i><b>11</b> Spark data caching</a><ul>
<li class="chapter" data-level="11.1" data-path="spark-data-caching.html"><a href="spark-data-caching.html#map-data"><i class="fa fa-check"></i><b>11.1</b> Map data</a></li>
<li class="chapter" data-level="11.2" data-path="spark-data-caching.html"><a href="spark-data-caching.html#caching-data"><i class="fa fa-check"></i><b>11.2</b> Caching data</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modeling-with-databases" class="section level1">
<h1><span class="header-section-number">7</span> Modeling with databases</h1>
<div id="single-step-sampling" class="section level2">
<h2><span class="header-section-number">7.1</span> Single step sampling</h2>
<p><em>Use PostgreSQL TABLESAMPLE clause</em></p>
<ol style="list-style-type: decimal">
<li><p>Use <code>connection_open()</code> to open a Database connection</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb182-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">connection_open</span>(</a>
<a class="sourceLine" id="cb182-2" data-line-number="2">  RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</a>
<a class="sourceLine" id="cb182-3" data-line-number="3">  <span class="dt">host =</span>  <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb182-4" data-line-number="4">  <span class="dt">user =</span> <span class="kw">get</span>(<span class="st">&quot;user&quot;</span>, <span class="dt">config =</span> <span class="st">&quot;datawarehouse&quot;</span>),</a>
<a class="sourceLine" id="cb182-5" data-line-number="5">  <span class="dt">password =</span> <span class="kw">get</span>(<span class="st">&quot;password&quot;</span>, <span class="dt">config =</span> <span class="st">&quot;datawarehouse&quot;</span>),</a>
<a class="sourceLine" id="cb182-6" data-line-number="6">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb182-7" data-line-number="7">  <span class="dt">dbname =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb182-8" data-line-number="8">  <span class="dt">bigint =</span> <span class="st">&quot;integer&quot;</span></a>
<a class="sourceLine" id="cb182-9" data-line-number="9">)</a></code></pre></div></li>
<li><p>Set the <code>orders</code> variable to point to the <strong>orders</strong> table</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb183-1" data-line-number="1">orders &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;datawarehouse&quot;</span>, <span class="st">&quot;orders&quot;</span>))</a></code></pre></div></li>
<li><p>Set the <code>orders_view</code> variable to point to the <strong>v_orders</strong> table</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb184-1" data-line-number="1">orders_view &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;datawarehouse&quot;</span>, <span class="st">&quot;v_orders&quot;</span>))</a></code></pre></div></li>
<li><p>Pipe <code>orders</code> into the function <code>show_query()</code></p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb185-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-2" data-line-number="2"><span class="st">  </span><span class="kw">show_query</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT *
## FROM datawarehouse.orders</code></pre></li>
<li><p>Pipe the previous command into the <code>class()</code> function to see the kind of output <code>show_query()</code> returns</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb187-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb187-2" data-line-number="2"><span class="st">  </span><span class="kw">show_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb187-3" data-line-number="3"><span class="st">  </span><span class="kw">class</span>()</a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT *
## FROM datawarehouse.orders</code></pre>
<pre><code>## [1] &quot;tbl_conn&quot;         &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot;          &quot;tbl_sql&quot;          &quot;tbl_lazy&quot;         &quot;tbl&quot;</code></pre></li>
<li><p>Replace <code>show_query()</code> with <code>remote_query()</code> to compare the output types</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb190-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-2" data-line-number="2"><span class="st">  </span><span class="kw">remote_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-3" data-line-number="3"><span class="st">  </span><span class="kw">class</span>()</a></code></pre></div>
<pre><code>## [1] &quot;sql&quot;       &quot;character&quot;</code></pre></li>
<li><p>Replace <code>class()</code> with <code>build_sql()</code>. Use <code>con</code> as the value for the <code>con</code> argument</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb192-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb192-2" data-line-number="2"><span class="st">  </span><span class="kw">remote_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb192-3" data-line-number="3"><span class="st">  </span><span class="kw">build_sql</span>(<span class="dt">con =</span> con)</a></code></pre></div>
<pre><code>## &lt;SQL&gt; SELECT *
## FROM datawarehouse.orders</code></pre></li>
<li><p>Add <em>&quot; TABLESAMPLE BERNOULLI (0.1)&quot;</em> to <code>build_sql()</code> as another <code>...</code> argument</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb194-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb194-2" data-line-number="2"><span class="st">  </span><span class="kw">remote_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb194-3" data-line-number="3"><span class="st">  </span><span class="kw">build_sql</span>(<span class="dt">con =</span> con, <span class="st">&quot; TABLESAMPLE BERNOULLI (0.1)&quot;</span>)</a></code></pre></div>
<pre><code>## &lt;SQL&gt; SELECT *
## FROM datawarehouse.orders TABLESAMPLE BERNOULLI (0.1)</code></pre></li>
<li><p>Pipe the code into <code>tbl()</code>. Use <code>con</code> for the <code>con</code> argument, and <code>.</code> for the rest</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb196-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb196-2" data-line-number="2"><span class="st">  </span><span class="kw">remote_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb196-3" data-line-number="3"><span class="st">  </span><span class="kw">build_sql</span>(<span class="dt">con =</span> con, <span class="st">&quot; TABLESAMPLE BERNOULLI (0.1)&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb196-4" data-line-number="4"><span class="st">  </span><span class="kw">tbl</span>(con, .) </a></code></pre></div>
<pre><code>## # Source:   SQL [?? x 3]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_id customer_id step_id
##       &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;
##  1     6544          36       6
##  2    10969          69      10
##  3    45368           4      45
##  4    73207          23      73
##  5    79874          71      79
##  6    86553          69      86
##  7    86559          48      86
##  8   103209          58     103
##  9   105466           2     105
## 10   127623          81     127
## # … with more rows</code></pre></li>
<li><p>Use <code>inner_join()</code> to add the information from the <code>orders_view</code> pointer, use <code>order_id</code> as the matching field</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb198-1" data-line-number="1">orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb198-2" data-line-number="2"><span class="st">  </span><span class="kw">remote_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb198-3" data-line-number="3"><span class="st">  </span><span class="kw">build_sql</span>(<span class="dt">con =</span> con, <span class="st">&quot; TABLESAMPLE BERNOULLI (0.1)&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb198-4" data-line-number="4"><span class="st">  </span><span class="kw">tbl</span>(con, .)  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb198-5" data-line-number="5"><span class="st">  </span><span class="kw">inner_join</span>(orders_view, <span class="dt">by =</span> <span class="st">&quot;order_id&quot;</span>) </a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 12]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_id customer_id.x step_id date       date_year date_month customer_id.y customer_name         customer_lon customer_lat order_total order_qty
##       &lt;int&gt;         &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;          &lt;int&gt;      &lt;int&gt;         &lt;int&gt; &lt;chr&gt;                        &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;     &lt;int&gt;
##  1     2169            59       2 2016-01-02      2016          1            59 Junie Kuhlman                -122.         37.8        34.8         5
##  2    18762            84      18 2016-01-18      2016          1            84 Jep Greenfelder-Bayer        -122.         37.8        18.4         3
##  3    22115            50      22 2016-01-22      2016          1            50 Channing Pacocha             -122.         37.7        17.3         3
##  4    57682             6      57 2016-02-26      2016          2             6 Meggan Bruen                 -122.         37.7        21.4         3
##  5    78727            84      78 2016-03-18      2016          3            84 Jep Greenfelder-Bayer        -122.         37.8        10.6         2
##  6    80958             9      80 2016-03-20      2016          3             9 Kip Eichmann                 -122.         37.7        25.6         4
##  7    86568            68      86 2016-03-26      2016          3            68 Clement Haley                -122.         37.8        28.3         4
##  8    92136             9      92 2016-04-01      2016          4             9 Kip Eichmann                 -122.         37.7        47.7         6
##  9   144316            70     144 2016-05-23      2016          5            70 Reggie Mills                 -122.         37.7        23.6         4
## 10   152180            50     152 2016-05-31      2016          5            50 Channing Pacocha             -122.         37.7        32.0         5
## # … with more rows</code></pre></li>
<li><p>Assign the resulting code to a variable <code>orders_sample_db</code></p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb200-1" data-line-number="1">orders_sample_db &lt;-<span class="st"> </span>orders <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-2" data-line-number="2"><span class="st">  </span><span class="kw">remote_query</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-3" data-line-number="3"><span class="st">  </span><span class="kw">build_sql</span>(<span class="dt">con =</span> con, <span class="st">&quot; TABLESAMPLE BERNOULLI (0.1)&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-4" data-line-number="4"><span class="st">  </span><span class="kw">tbl</span>(con, .)  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-5" data-line-number="5"><span class="st">  </span><span class="kw">inner_join</span>(orders_view, <span class="dt">by =</span> <span class="st">&quot;order_id&quot;</span>) </a></code></pre></div></li>
<li><p>Use <code>collect()</code> to load the results of <code>orders_sample_db</code> to a new variable called <code>orders_sample</code></p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb201-1" data-line-number="1">orders_sample &lt;-<span class="st"> </span><span class="kw">collect</span>(orders_sample_db)</a></code></pre></div></li>
<li><p>Load the <code>dbplot</code> library</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb202-1" data-line-number="1"><span class="kw">library</span>(dbplot)</a></code></pre></div></li>
<li><p>Use <code>dbplot_histogram()</code> to visualize the distribution of <code>order_total</code> from <code>orders_sample</code></p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb203-1" data-line-number="1">orders_sample <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb203-2" data-line-number="2"><span class="st">  </span><span class="kw">dbplot_histogram</span>(order_total, <span class="dt">binwidth =</span> <span class="dv">5</span>)</a></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-145-1.png" width="672" /></p></li>
<li><p>Use <code>dbplot_histogram()</code> to visualize the distribution of <code>order_total</code> from <code>orders_view</code></p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb204-1" data-line-number="1">orders_view <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb204-2" data-line-number="2"><span class="st">  </span><span class="kw">dbplot_histogram</span>(order_total, <span class="dt">binwidth =</span> <span class="dv">5</span>)</a></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-146-1.png" width="672" /></p></li>
</ol>
</div>
<div id="using-tidymodels-for-modeling" class="section level2">
<h2><span class="header-section-number">7.2</span> Using <code>tidymodels</code> for modeling</h2>
<p><em>Fit and measure the model’s performance using functions from <code>parsnip</code> and <code>yardstick</code></em></p>
<ol style="list-style-type: decimal">
<li><p>Load the <code>tidymodels</code> library</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb205-1" data-line-number="1"><span class="kw">library</span>(tidymodels)</a></code></pre></div></li>
<li><p>Start with the <code>linear_reg()</code> command, pipe into <code>set_engine()</code>, and use <em>“lm”</em> as its sole argument</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb206-1" data-line-number="1"><span class="kw">linear_reg</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb206-2" data-line-number="2"><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;lm&quot;</span>) </a></code></pre></div>
<pre><code>## Linear Regression Model Specification (regression)
## 
## Computational engine: lm</code></pre></li>
<li><p>Pipe into the <code>fit()</code> command. Use the formula: <code>order_total ~ order_qty</code>, and <code>orders_sample</code> as the <code>data</code> argument</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb208-1" data-line-number="1"><span class="kw">linear_reg</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb208-2" data-line-number="2"><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;lm&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb208-3" data-line-number="3"><span class="st">  </span><span class="kw">fit</span>(order_total <span class="op">~</span><span class="st"> </span>order_qty, <span class="dt">data =</span> orders_sample)</a></code></pre></div>
<pre><code>## parsnip model object
## 
## Fit in:  26ms
## Call:
## stats::lm(formula = formula, data = data)
## 
## Coefficients:
## (Intercept)    order_qty  
##     -0.8562       7.0699</code></pre></li>
<li><p>Assign the previous code to a variable called <code>parsnip_model</code></p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb210-1" data-line-number="1">parsnip_model &lt;-<span class="st"> </span><span class="kw">linear_reg</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb210-2" data-line-number="2"><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;lm&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb210-3" data-line-number="3"><span class="st">  </span><span class="kw">fit</span>(order_total <span class="op">~</span><span class="st"> </span>order_qty, <span class="dt">data =</span> orders_sample)</a></code></pre></div></li>
<li><p>Use <code>bind_cols()</code> to add the predictions to <code>order_sample</code>. Calculate the prediction with <code>predict()</code></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb211-1" data-line-number="1">orders_sample <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb211-2" data-line-number="2"><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">predict</span>(parsnip_model, orders_sample))</a></code></pre></div>
<pre><code>## # A tibble: 101 x 13
##    order_id customer_id.x step_id date       date_year date_month customer_id.y customer_name            customer_lon customer_lat order_total order_qty .pred
##       &lt;int&gt;         &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;          &lt;int&gt;      &lt;int&gt;         &lt;int&gt; &lt;chr&gt;                           &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;     &lt;int&gt; &lt;dbl&gt;
##  1     8734            87       8 2016-01-08      2016          1            87 Lasonya Bailey-Langworth        -122.         37.8        5.21         1  6.21
##  2    24398            60      24 2016-01-24      2016          1            60 Jonas Abshire                   -122.         37.8       32.0          4 27.4 
##  3    32103            73      32 2016-02-01      2016          2            73 Merlyn Runolfsson               -122.         37.7       20.9          3 20.4 
##  4    32158            80      32 2016-02-01      2016          2            80 Jessee Rodriguez Jr.            -122.         37.7        8.34         1  6.21
##  5    42123            61      42 2016-02-11      2016          2            61 Cedric O&#39;Kon-Wisoky             -122.         37.8       14.9          2 13.3 
##  6    46478            42      46 2016-02-15      2016          2            42 Rodolfo Denesik                 -122.         37.8       18.4          3 20.4 
##  7    50895            16      50 2016-02-19      2016          2            16 Mordechai Schultz               -122.         37.7       26.2          4 27.4 
##  8    64366            26      64 2016-03-04      2016          3            26 Lura Koepp                      -122.         37.7       25.0          4 27.4 
##  9    67620            72      67 2016-03-07      2016          3            72 Eduardo Bins                    -122.         37.8       21.6          3 20.4 
## 10    69842            43      69 2016-03-09      2016          3            43 Chadrick Konopelski             -122.         37.7       26.0          3 20.4 
## # … with 91 more rows</code></pre></li>
<li><p>Pipe the code into the <code>metrics()</code> function. Use <code>order_total</code> as the <code>truth</code> argument, and <code>.pred</code> as the <code>estimate</code> argument</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb213-1" data-line-number="1">orders_sample <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb213-2" data-line-number="2"><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">predict</span>(parsnip_model, orders_sample)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb213-3" data-line-number="3"><span class="st">  </span><span class="kw">metrics</span>(<span class="dt">truth =</span> order_total, <span class="dt">estimate =</span> .pred)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard       2.64 
## 2 rsq     standard       0.926
## 3 mae     standard       2.07</code></pre></li>
</ol>
</div>
<div id="score-with-tidypredict" class="section level2">
<h2><span class="header-section-number">7.3</span> Score with <code>tidypredict</code></h2>
<ol style="list-style-type: decimal">
<li><p>Load the <code>tidypredict</code> library</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb215-1" data-line-number="1"><span class="kw">library</span>(tidypredict)</a></code></pre></div></li>
<li><p>Use the <code>parse_model()</code> function to parse <code>parsnip_model</code>, and assign it to a variable called <code>parsed_parsnip</code></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb216-1" data-line-number="1">parsed_parsnip &lt;-<span class="st"> </span><span class="kw">parse_model</span>(parsnip_model)</a></code></pre></div></li>
<li><p>Use <code>str()</code> to see the <code>parsed_parsnip</code> object’s structure</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb217-1" data-line-number="1"><span class="kw">str</span>(parsed_parsnip)</a></code></pre></div>
<pre><code>## List of 2
##  $ general:List of 6
##   ..$ model   : chr &quot;lm&quot;
##   ..$ version : num 2
##   ..$ type    : chr &quot;regression&quot;
##   ..$ residual: int 99
##   ..$ sigma2  : num 7.13
##   ..$ is_glm  : num 0
##  $ terms  :List of 2
##   ..$ :List of 5
##   .. ..$ label       : chr &quot;(Intercept)&quot;
##   .. ..$ coef        : num -0.856
##   .. ..$ is_intercept: num 1
##   .. ..$ fields      :List of 1
##   .. .. ..$ :List of 2
##   .. .. .. ..$ type: chr &quot;ordinary&quot;
##   .. .. .. ..$ col : chr &quot;(Intercept)&quot;
##   .. ..$ qr          :List of 2
##   .. .. ..$ qr_1: num -0.0995
##   .. .. ..$ qr_2: num 0.237
##   ..$ :List of 5
##   .. ..$ label       : chr &quot;order_qty&quot;
##   .. ..$ coef        : num 7.07
##   .. ..$ is_intercept: num 0
##   .. ..$ fields      :List of 1
##   .. .. ..$ :List of 2
##   .. .. .. ..$ type: chr &quot;ordinary&quot;
##   .. .. .. ..$ col : chr &quot;order_qty&quot;
##   .. ..$ qr          :List of 2
##   .. .. ..$ qr_1: num 0
##   .. .. ..$ qr_2: num -0.0754
##  - attr(*, &quot;class&quot;)= chr [1:3] &quot;parsed_model&quot; &quot;pm_regression&quot; &quot;list&quot;</code></pre></li>
<li><p>Use <code>tidypredict_fit()</code> to view the <code>dplyr</code> formula that calculates the prediction</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb219-1" data-line-number="1"><span class="kw">tidypredict_fit</span>(parsed_parsnip)</a></code></pre></div>
<pre><code>## -0.856204588910169 + (order_qty * 7.06989483747611)</code></pre></li>
<li><p>Use <code>head()</code> to get the first 10 records from <code>orders_view</code></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb221-1" data-line-number="1">orders_view <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb221-2" data-line-number="2"><span class="st">  </span><span class="kw">head</span>(<span class="dv">10</span>)</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 10]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_id date       date_year date_month customer_id customer_name            customer_lon customer_lat order_total order_qty
##       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;      &lt;int&gt;       &lt;int&gt; &lt;chr&gt;                           &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;     &lt;int&gt;
##  1     1001 2016-01-01      2016          1          36 Jeptha Ziemann                  -122.         37.7       10.9          2
##  2     1002 2016-01-01      2016          1          21 Miss Azzie Jaskolski            -122.         37.8       29.4          4
##  3     1003 2016-01-01      2016          1          64 Amber Harber                    -122.         37.8       31.0          5
##  4     1004 2016-01-01      2016          1          85 Mat Luettgen                    -122.         37.8       42            6
##  5     1005 2016-01-01      2016          1          41 Dr. Dionte Quigley Jr.          -122.         37.8       27.2          4
##  6     1006 2016-01-01      2016          1          70 Reggie Mills                    -122.         37.7       12.7          2
##  7     1007 2016-01-01      2016          1          10 Ms. Ciarra Borer                -122.         37.8       11.3          2
##  8     1008 2016-01-01      2016          1          78 Pricilla Goodwin                -122.         37.8        5.47         1
##  9     1009 2016-01-01      2016          1          56 Kimora Bergnaum                 -122.         37.7       19.9          3
## 10     1010 2016-01-01      2016          1          71 Erle Christiansen-Larkin        -122.         37.7       18.6          3</code></pre></li>
<li><p>Pipe the code into <code>mutate()</code>. Assign to a new <code>my_pred</code> variable the results of <code>tidypredict_fit()</code>. Make sure to prefix <code>tidypredict_fit()</code> with the bang-bang operator so that the formula is evaluated.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb223-1" data-line-number="1">orders_view <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb223-2" data-line-number="2"><span class="st">  </span><span class="kw">head</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb223-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">my_pred =</span> <span class="op">!!</span><span class="st"> </span><span class="kw">tidypredict_fit</span>(parsed_parsnip))</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 11]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_id date       date_year date_month customer_id customer_name            customer_lon customer_lat order_total order_qty my_pred
##       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;      &lt;int&gt;       &lt;int&gt; &lt;chr&gt;                           &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;     &lt;int&gt;   &lt;dbl&gt;
##  1     1001 2016-01-01      2016          1          36 Jeptha Ziemann                  -122.         37.7       10.9          2   13.3 
##  2     1002 2016-01-01      2016          1          21 Miss Azzie Jaskolski            -122.         37.8       29.4          4   27.4 
##  3     1003 2016-01-01      2016          1          64 Amber Harber                    -122.         37.8       31.0          5   34.5 
##  4     1004 2016-01-01      2016          1          85 Mat Luettgen                    -122.         37.8       42            6   41.6 
##  5     1005 2016-01-01      2016          1          41 Dr. Dionte Quigley Jr.          -122.         37.8       27.2          4   27.4 
##  6     1006 2016-01-01      2016          1          70 Reggie Mills                    -122.         37.7       12.7          2   13.3 
##  7     1007 2016-01-01      2016          1          10 Ms. Ciarra Borer                -122.         37.8       11.3          2   13.3 
##  8     1008 2016-01-01      2016          1          78 Pricilla Goodwin                -122.         37.8        5.47         1    6.21
##  9     1009 2016-01-01      2016          1          56 Kimora Bergnaum                 -122.         37.7       19.9          3   20.4 
## 10     1010 2016-01-01      2016          1          71 Erle Christiansen-Larkin        -122.         37.7       18.6          3   20.4</code></pre></li>
<li><p>Replace the <code>mutate()</code> command with <code>tidypredict_to_column()</code></p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" data-line-number="1">orders_view <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-2" data-line-number="2"><span class="st">  </span><span class="kw">head</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb225-3" data-line-number="3"><span class="st">  </span><span class="kw">tidypredict_to_column</span>(parsnip_model)</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 11]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_id date       date_year date_month customer_id customer_name            customer_lon customer_lat order_total order_qty   fit
##       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;      &lt;int&gt;       &lt;int&gt; &lt;chr&gt;                           &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;     &lt;int&gt; &lt;dbl&gt;
##  1     1001 2016-01-01      2016          1          36 Jeptha Ziemann                  -122.         37.7       10.9          2 13.3 
##  2     1002 2016-01-01      2016          1          21 Miss Azzie Jaskolski            -122.         37.8       29.4          4 27.4 
##  3     1003 2016-01-01      2016          1          64 Amber Harber                    -122.         37.8       31.0          5 34.5 
##  4     1004 2016-01-01      2016          1          85 Mat Luettgen                    -122.         37.8       42            6 41.6 
##  5     1005 2016-01-01      2016          1          41 Dr. Dionte Quigley Jr.          -122.         37.8       27.2          4 27.4 
##  6     1006 2016-01-01      2016          1          70 Reggie Mills                    -122.         37.7       12.7          2 13.3 
##  7     1007 2016-01-01      2016          1          10 Ms. Ciarra Borer                -122.         37.8       11.3          2 13.3 
##  8     1008 2016-01-01      2016          1          78 Pricilla Goodwin                -122.         37.8        5.47         1  6.21
##  9     1009 2016-01-01      2016          1          56 Kimora Bergnaum                 -122.         37.7       19.9          3 20.4 
## 10     1010 2016-01-01      2016          1          71 Erle Christiansen-Larkin        -122.         37.7       18.6          3 20.4</code></pre></li>
<li><p>Load the <code>yaml</code> library</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb227-1" data-line-number="1"><span class="kw">library</span>(yaml)</a></code></pre></div></li>
<li><p>Use <code>write_yaml()</code> to save the contents of <code>parsed_parsnip</code> into a file called <strong>model.yaml</strong></p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" data-line-number="1"><span class="kw">write_yaml</span>(parsed_parsnip, <span class="st">&quot;model.yaml&quot;</span>)</a></code></pre></div></li>
<li><p>Using <code>read_yaml()</code>, read the contents of the <strong>model.yaml</strong> file into the a new variable called <code>loaded_model</code></p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb229-1" data-line-number="1">loaded_model &lt;-<span class="st"> </span><span class="kw">read_yaml</span>(<span class="st">&quot;model.yaml&quot;</span>)</a></code></pre></div></li>
<li><p>Use <code>as_parsed_model()</code> to convert the <code>loaded_model</code> variable into a <code>tidypredict</code> parsed model object, assign the results to <code>loaded_model_2</code></p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" data-line-number="1">loaded_model_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">as_parsed_model</span>(loaded_model)</a></code></pre></div></li>
</ol>
</div>
<div id="run-predictions-in-db" class="section level2">
<h2><span class="header-section-number">7.4</span> Run predictions in DB</h2>
<ol style="list-style-type: decimal">
<li><p>Load the <code>modeldb</code> library</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb231-1" data-line-number="1"><span class="kw">library</span>(modeldb)</a></code></pre></div></li>
<li><p>Use <code>select()</code> to pick the <code>order_total</code> and <code>order_qty</code> fields from the <code>orders_sample_db</code> table pointer</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" data-line-number="1">orders_sample_db <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb232-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(order_total, order_qty) </a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_total order_qty
##          &lt;dbl&gt;     &lt;int&gt;
##  1        13.3         2
##  2        16.9         3
##  3        43.4         5
##  4        54.0         7
##  5        54.0         7
##  6        23.7         3
##  7        14.5         2
##  8        36.9         6
##  9        12.3         2
## 10        24.2         4
## # … with more rows</code></pre></li>
<li><p>Pipe the code into the <code>linear_regression_db()</code> function, pass <code>order_total</code> as the only argument</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb234-1" data-line-number="1">orders_sample_db <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(order_total, order_qty) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb234-3" data-line-number="3"><span class="st">  </span><span class="kw">linear_regression_db</span>(order_total)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   `(Intercept)` order_qty
##           &lt;dbl&gt;     &lt;dbl&gt;
## 1        -0.391      6.85</code></pre></li>
<li><p>Assign the model results to a new variable called <code>db_model</code></p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" data-line-number="1">db_model &lt;-<span class="st"> </span>orders_sample_db <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(order_total, order_qty) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb236-3" data-line-number="3"><span class="st">  </span><span class="kw">linear_regression_db</span>(order_total)</a></code></pre></div></li>
<li><p>Use <code>as_parsed_model()</code> to convert <code>db_model</code> to a parsed model object. Assign to new a variable called <code>pm</code></p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb237-1" data-line-number="1">pm &lt;-<span class="st"> </span><span class="kw">as_parsed_model</span>(db_model)</a></code></pre></div></li>
<li><p>Use <code>head()</code> to get the top 10 records, and then pipe into <code>tidypredict_to_column()</code> to add the results from <code>pm</code></p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb238-1" data-line-number="1">orders_view <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb238-2" data-line-number="2"><span class="st">  </span><span class="kw">head</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb238-3" data-line-number="3"><span class="st">  </span><span class="kw">tidypredict_to_column</span>(pm)</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 11]
## # Database: postgres [rstudio_admin@localhost:5432/postgres]
##    order_id date       date_year date_month customer_id customer_name            customer_lon customer_lat order_total order_qty   fit
##       &lt;int&gt; &lt;chr&gt;          &lt;int&gt;      &lt;int&gt;       &lt;int&gt; &lt;chr&gt;                           &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;     &lt;int&gt; &lt;dbl&gt;
##  1     1001 2016-01-01      2016          1          36 Jeptha Ziemann                  -122.         37.7       10.9          2 13.4 
##  2     1002 2016-01-01      2016          1          21 Miss Azzie Jaskolski            -122.         37.8       29.4          4 27.2 
##  3     1003 2016-01-01      2016          1          64 Amber Harber                    -122.         37.8       31.0          5 34.1 
##  4     1004 2016-01-01      2016          1          85 Mat Luettgen                    -122.         37.8       42            6 40.9 
##  5     1005 2016-01-01      2016          1          41 Dr. Dionte Quigley Jr.          -122.         37.8       27.2          4 27.2 
##  6     1006 2016-01-01      2016          1          70 Reggie Mills                    -122.         37.7       12.7          2 13.4 
##  7     1007 2016-01-01      2016          1          10 Ms. Ciarra Borer                -122.         37.8       11.3          2 13.4 
##  8     1008 2016-01-01      2016          1          78 Pricilla Goodwin                -122.         37.8        5.47         1  6.55
##  9     1009 2016-01-01      2016          1          56 Kimora Bergnaum                 -122.         37.7       19.9          3 20.3 
## 10     1010 2016-01-01      2016          1          71 Erle Christiansen-Larkin        -122.         37.7       18.6          3 20.3</code></pre></li>
</ol>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-visualizations.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="advanced-operations.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

</body>

</html>
