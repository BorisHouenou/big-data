```{r setup, include = FALSE}
library(data.table)
library(dtplyr)
library(dplyr)
library(tidyr)
library(lobstr)
library(vroom)
library(fs)
library(purrr)
#knitr::opts_chunk$set(eval = FALSE)
```

# Large files

## Introduction to `vroom`
*Load data into R using `vroom`*

1. Load the `vroom()` library
    ```{r}
    library(vroom)
    ```

1. Use the `vroom()` function to read the **transactions_1.csv** file from the **data** folder
    ```{r}
    vroom("data/transactions_1.csv")
    ```

1. Use the `id` argument to add the file name to the data frame.  Use **file_name** as the argument's value
    ```{r}
    vroom("data/transactions_1.csv", id = "file_name")
    ```

1. Load the prior command into a variable called `vr_transactions`
    ```{r}
    vr_transactions <- vroom("data/transactions_1.csv", id = "file_name")
    
    vr_transactions
    ```

1. Load the file spec into a variable called `vr_spec`, using the `spec()` command
    ```{r}
    vr_spec <- spec(vr_transactions)
    
    vr_spec
    ```

## Using `fs` and `purrr`
*Load multiple files*

1. Load the `fs` library
    ```{r}
    library(fs)
    ```

1. List files in the **data** folder using the `dir_ls()` function
    ```{r}
    dir_ls("data")
    ```

1. In the `dir_ls()` function, use the `glob` argument to pass a wildcard to list CSV files only
    ```{r}
    dir_ls("data", glob = "*.csv")
    ```

1. Load the `purrr` library
    ```{r}
    library(purrr)
    ```

1. Use the `map_dfr()` function to run the `vroom()` function, over the contents of the **data** folder. Pass the `n_max` argument with a value of 5, to make sure that the files are read quickly.
    ```{r}
    dir_ls("data", glob = "*.csv") %>%
      map_dfr(vroom, n_max = 5)
    ```

1. Add the `spec` argument to `map_dfr()`, use the `vr_spec` variable as the value
    ```{r}
    dir_ls("data", glob = "*.csv") %>%
      map_dfr(vroom, n_max = 5, col_types = vr_spec)
    ```

1. Add the `col_select` argument to `map_dfr()`.  Use a `list` object to select `transaction_id`, `order_id`, `customer_name` and `price` 
    ```{r}
    dir_ls("data", glob = "*.csv") %>%
      map_dfr(vroom, n_max = 5, col_types = vr_spec, 
              col_select = list(transaction_id, order_id, order_date, customer_name, price)
              )
    ```

## Load and modify multiple files
*Files to large to have in memory, keep summarization*

1. Load the contents of the **data** folder in a variable called `files`
    ```{r}
    files <- dir_ls("data", glob = "*.csv") 
    ```

1. Use a `for()` loop to print the content of each vector inside `files`
    ```{r}
    for(i in seq_along(files)) {
      print(files[i])
    }
    ```

1. Switch the `print()` command with the `vroom` command, using the same arguments, except the file name.  Use the `files` variable.  Load the results into a variable called `transactions`. 
    ```{r}
    for(i in seq_along(files)) {
      transactions <- vroom(files[i], n_max = 1000, col_types = vr_spec, 
                           col_select = list(transaction_id, order_id, 
                                             order_date, customer_name, price))

    }
    ```

1. Group `transactions` by `order_id` and get the total of `price` and the number of records. Name them `total_sales` and `no_items` respectively. Name the new variable `orders`
    ```{r}
    for(i in seq_along(files)) {
      transactions <- vroom(files[i], n_max = 1000, col_types = vr_spec, 
                           col_select = list(transaction_id, order_id, order_date, customer_name, price))
      orders <- transactions %>%
        group_by(order_id) %>%
        summarise(total_sales = sum(price), no_items = n())
    }
    ```

1. Add a new variable called `all_orders` at the top. Set it to `NULL`. Add a `bind_rows()` step to `orders`, appending `all_orders`
    ```{r}
    all_orders <- NULL
    for(i in seq_along(files)) {
      transactions <- vroom(files[i], n_max = 1000, col_types = vr_spec, 
                           col_select = list(transaction_id, order_id, order_date, customer_name, price))
      orders <- transactions %>%
        group_by(order_id) %>%
        summarise(total_sales = sum(price), no_items = n()) %>%
        bind_rows(all_orders)
    }
    ```
    
1. Remove the `transactions` variable at the end of each cycle    
    ```{r}
    all_orders <- NULL
    for(i in seq_along(files)) {
      transactions <- vroom(files[i], n_max = 1000, col_types = vr_spec, 
                           col_select = list(transaction_id, order_id, order_date, customer_name, price))
      orders <- transactions %>%
        group_by(order_id) %>%
        summarise(total_sales = sum(price), no_items = n()) %>%
        bind_rows(all_orders)
      rm(transactions)
    }
    ```

```{r, eval = FALSE, echo = FALSE}
vr_transactions <- dir_ls("data", glob = "*.csv") %>%
  map_dfr(vroom, id = "file_name") %>%
  separate(file_name, c(NA, NA, "batch_no"))
dir_ls("data", glob = "*.csv") %>%
  map_dfr(vroom, id = "file_name", n_max = 5)
vr_transactions %>%
  separate(file_name, c("one", "two", "three"))
vr_transactions %>%
  separate(file_name, c(NA, NA, "batch_no"))
vr_transactions %>%
  group_by(order_id) %>%
  summarise(
    date = max(order_date),
    no_products = n(),
    total_order = sum(price), 
    customer = max(customer_name)
    )
```

## Introduction to `dtplyr`
*Load data into R via `data.table`, and then wrap it with `dtplyr`*

1. Load the `data.table` library
    ```{r}
    library(data.table)
    ```

1. Read the **transactions.csv** file, from the **data** folder. Use the `fread()` function to load the data into a variable called `transactions`
    ```{r}
    transactions <- dir_ls("data", glob = "*.csv") %>%
       map(fread) %>%
       rbindlist()
    ```

1. Preview the data using `str()`
    ```{r}
    str(transactions)
    ```

1. Load the `dplyr` and `dtplyr` libraries
    ```{r}
    library(dplyr)
    library(dtplyr)
    ```

1. Use the `lazy_dt()` to "wrap" the `transactions` variable, into a new variable called `dt_transactions`
    ```{r}
    dt_transactions <- lazy_dt(transactions)
    ```


1. View the `dt_transactions` variable's structure with `str()`
    ```{r}
    str(dt_transactions)
    ```

## Object sizes
*Confirm that `dtplyr` is not making copies of the original `data.table`*

1. Load the `lobstr` library
    ```{r}
    library(lobstr)
    ```

1. Use `obj_size()` to obtain `transactions`'s size in memory
    ```{r}
    obj_size(transactions)
    ```

1. Use `obj_size()` to obtain `dt_transactions`'s size in memory
    ```{r}
    obj_size(dt_transactions)
    ```

1. Use `obj_size()` to obtain `dt_transactions` and `transactions` size in memory together
    ```{r}
    obj_size(transactions, dt_transactions)
    ```

## How `dtplyr` works
*Under the hood view of how `dtplyr` operates `data.table` objects*

1. Use `dplyr` verbs on top of `dt_transactions` to obtain the total sales by month
    ```{r}
    dt_transactions %>%
      group_by(order_date_month) %>%
      summarise(total_sales = sum(price))
    ```

1. Load the above code into a variable called `by_month`
    ```{r}
    by_month <- dt_transactions %>%
      group_by(order_date_month) %>%
      summarise(total_sales = sum(price))
    ```

1. Use `show_query()` to see the `data.table` code that `by_month` actually runs
    ```{r}
    show_query(by_month)
    ```

1. Use `str()` to view how `by_month`, instead of modifying the data, it only adds steps that will later be operated by `data.table`
    ```{r}
    str(by_month)
    ```

## Working with `dtplyr`
*Learn data conversion and basic visualization techniques*

1. Use `as_tibble()` to convert the results of `by_month` into a `tibble`
    ```{r}
    by_month %>%
      as_tibble()
    ```

1. Load the `ggplot2` library

    ```{r}
    library(ggplot2)
    ```

1. Use `as_tibble()` to convert before creating a line plot 
    ```{r}
    by_month %>%
      as_tibble() %>%
      ggplot() +
      geom_line(aes(order_date_month, total_sales))
    ```

## Pivot data
*Review a simple way to aggregate data faster, and then pivot it as a tibble*

1. Load the `tidyr` library
    ```{r}
    library(tidyr)
    ```

1. Group `db_transactions` by `order_date_month` and `order_date_day`, then aggregate `price` into `total_sales`
    ```{r}
    dt_transactions %>%
      group_by(order_date_month, order_date_day) %>% 
      summarise(total_sales = sum(price))
    ```

1. Copy the aggregation code above, **then collect it into a `tibble`**, and then use `pivot_wider()` to make the `order_date_day` the column headers.
    ```{r}
    dt_transactions %>%
      group_by(order_date_month, order_date_day) %>% 
      summarise(total_sales = sum(price)) %>%
      as_tibble() %>%
      pivot_wider(names_from = order_date_day, values_from = total_sales)
    ```


## The `mutate()` verb
*See how `dtplyr` creates a copy of the original `data.table` object in order to make the `mutate` operation work the same as it does on `dtplr`*

1. Use `mutate()` and `show_query()` to see the `copy()` command being used
    ```{r}
    dt_transactions %>%
      mutate(new_field = price / 2) %>%
      show_query()
    ```

1. Use `lazy_dt()` with the `immutable` argument set to `FALSE` to avoid the copy
    ```{r}
    lazy_dt(transactions, immutable = FALSE) %>%
      mutate(new_field = price / 2) %>%
      show_query()
    ```


