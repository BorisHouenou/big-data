```{r db-visualizations, include = FALSE}
eval_viz <- TRUE
```

```{r, eval = eval_viz, include = FALSE}
library(connections)
library(RSQLite)
library(dplyr)
library(dbplyr)
library(dbplot)
library(ggplot2)
```


# Data Visualizations

## Simple plot
*Practice pushing the calculations to the database*

1. Load the `connections` and `dplyr` libraries
    ```{r, eval = eval_viz}
    library(connections)
    library(dplyr)
    ```

1. Use `connection_open()` to open a Database connection
    ```{r, eval = eval_viz}
    con <- connection_open(RSQLite::SQLite(), "database/local.sqlite")
    ```

1. Use `tbl()` to create a pointer to the **v_transactions** table
    ```{r, eval = eval_viz}
    orders <- tbl(con, "v_orders")
    ```

1. Use `collect()` bring back the aggregated results into a "pass-through" variable called `by_year`
    ```{r, eval = eval_viz}
    by_year <- orders %>%
      count(order_date_year) %>%
      collect()
    ```

1. Preview the `by_year` variable
    ```{r, eval = eval_viz}
    by_year
    ```

1. Load the `ggplot2` library
    ```{r, eval = eval_viz}
    library(ggplot2)
    ```


1. Plot results using `ggplot2`
    ```{r, eval = eval_viz}
      ggplot(by_year) +
      geom_col(aes(order_date_year, n)) 
    ```

1. Using the code in this section, create a single piped code set which also creates the plot
    ```{r, eval = eval_viz}
    orders %>%
      count(order_date_year) %>%
      collect() %>%
      ggplot() +            # < Don't forget to switch to `+`
      geom_col(aes(order_date_year, n)) 
    ```

## Plot in one code segment
*Practice going from `dplyr` to `ggplot2` without using pass-through variable, great for EDA*

1. Summarize the order totals in a new variable called: *sales*
    ```{r, eval = eval_viz}
    orders %>%
      summarise(sales = sum(order_total))
    ```

1. Summarize the order totals in a new variable called: *sales*
    ```{r, eval = eval_viz}
    orders %>%
      group_by(order_date_year) %>%
      summarise(sales = sum(order_total))
    ```
    
1. Summarize the order totals in a new variable called: *sales*
    ```{r, eval = eval_viz}
    orders %>%
      group_by(order_date_year) %>%
      summarise(sales = sum(order_total)) %>%
      ggplot() +
      geom_col(aes(order_date_year, sales))
    ```

1. Switch the calculation to reflect the average of the order sale total
    ```{r, eval = eval_viz}
    orders %>%
      group_by(order_date_year) %>%
      summarise(sales = mean(order_total)) %>%
      ggplot() +
      geom_col(aes(order_date_year, sales))
    ```


```{r, eval = TRUE, echo = FALSE}
knitr::opts_chunk$set(eval = FALSE, echo = FALSE)
```


## Plot specific data segments
*Combine skills from previous units to create more sophisticated plots*

1. Switch the calculation to reflect the average of the order sale total
    ```{r, eval = eval_viz}
    orders %>%
      group_by(customer_id) %>%
      summarise(sales = sum(order_total)) %>%
      arrange(desc(sales)) %>%
      head(5) %>%
      pull(customer_id)
    ```

1. Start with getting the top 5 carriers
```{r}
flights %>%
  group_by(uniquecarrier) %>%
  tally() %>%
  arrange(desc(n)) %>%
  head(5) 
```

2. Pipe the top 5 carriers to a plot
```{r}
flights %>%
  group_by(uniquecarrier) %>%
  tally() %>%
  mutate(n = as.numeric(n)) %>%
  arrange(desc(n)) %>%
  head(5) %>%
  collect() %>%
  ggplot() +
    geom_col(aes(x = uniquecarrier, y = n))
```

3. Improve the plot's look
```{r}
flights %>%
  group_by(uniquecarrier) %>%
  tally() %>%
  mutate(n = as.numeric(n)) %>%
  arrange(desc(n)) %>%
  head(5) %>%
  collect() %>%
  ggplot() +      #Don't forget to switch to `+`
  geom_col(aes(x = forcats::fct_reorder(uniquecarrier, n), # Order by n
               y = n, 
               fill = n), # Add fill
           show.legend = FALSE) +  # Turn legend off
  scale_y_continuous(labels = scales::comma) + # Add commas to axis label numbers
  coord_flip() +  # Rotate cols into rows
  labs(title = "Top 5 Carriers", 
       subtitle = "Source: Datawarehouse",
       x = "Carrier Name", 
       y = "# of Flights")
```

## Plot correlations
*Use the `corrr` package to plot correlations*

1. Correlate select numeric columns from the flights table
```{r}
library(corrr)
flights_cor <- flights %>% 
  select(contains("delay")) %>% 
  correlate(use = "complete.obs")
```

2. Visualize the correlations
```{r}
flights_cor %>% 
  rplot()
```

3. Visualize correlation network
```{r}
flights_cor %>% 
  network_plot(min_cor = .15)
```


## Two or more queries
*Learn how to use `pull()` to pass a set of values to be used on a secondary query*

1. Use `pull()` to get the top 5 carriers loaded in a vector
```{r}
top5 <- flights %>%
  group_by(uniquecarrier) %>%
  tally() %>%
  arrange(desc(n)) %>%
  head(5) %>%
  pull(uniquecarrier)
top5
```

2. Use `%in%` to pass the `top5` vector to a filter
```{r}
flights %>%
  filter(uniquecarrier %in% top5)
```

3. Group by carrier and get the average arrival delay
```{r}
flights %>%
  filter(uniquecarrier %in% top5) %>%
  group_by(uniquecarrier) %>%
  summarise(n = mean(arrdelay, na.rm = TRUE))
```

4. Copy the final `ggplot()` code from the *Plot specific data segments* section. Update the `y` labs.
```{r}
flights %>%
  filter(uniquecarrier %in% top5) %>%
  group_by(uniquecarrier) %>%
  summarise(n = mean(arrdelay, na.rm = TRUE)) %>%
  # From previous section ----------------------------------------------
  collect() %>%
  ggplot() +      #Don't forget to switch to `+`
  geom_col(aes(x = forcats::fct_reorder(uniquecarrier, n), # Order by n
               y = n, 
               fill = n), # Add fill
           show.legend = FALSE) +  # Turn legend off
  coord_flip() +  # Rotate cols into rows
  labs(title = "Top 5 Carriers", 
       subtitle = "Source: Datawarehouse",
       x = "Carrier Name", 
       y = "Average Delay")
```

## Visualize using `dbplot`
*Review how to use `dbplot` to make it easier to plot with databases*

1. Install and load `dbplot`
```{r, eval = FALSE}
library(dbplot)
```

2. Create a line plot using the helper function `dbplot_line()`

```{r}
flights %>% 
  count(month)
```


```{r}
flights %>%
  dbplot_line(month)
flights %>% 
  db_compute_bins(month)
```

3. Update the plot's labels
```{r}
flights %>%
  dbplot_line(month) +
  labs(title = "Monthly flights",
       x = "Month",
       y = "Number of flights") 
```

## Plot a different aggregation
*`dbplot` allows for aggregate functions, other than record count, to be used for plotting*

1. Plot the average departure delay by day of week
```{r}
flights %>%
  dbplot_bar(dayofweek, mean(depdelay, na.rm = TRUE))
```

2. Change the day numbers to day name labels
```{r}
flights %>%
  dbplot_bar(dayofweek, mean(depdelay, na.rm = TRUE)) +
  scale_x_continuous(
    labels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"),
    breaks = 1:7
  )
```


## Create a histogram
*Use the package's function to easily create a histogram*

1. Use the `dbplot_histogram()` to build the histogram
```{r}
orders %>%
  dbplot_histogram(order_total, bins = 10)
```


2. Adjust the `binwidth` to 300

```{r}
flights %>%
  dbplot_histogram(distance, binwidth = 300)
```

## Raster plot

1. Use a `dbplot_raster()` to visualize `deptime` versus `depdelay`
```{r}
flights %>%
  dbplot_raster(deptime, arrtime)
```

2. Change the plot's resolution to 500
```{r}
flights %>%
  dbplot_raster(deptime, arrtime, resolution = 500)
```


## Using the `calculate` functions

1. Use the `db_compute_raster()` function to get the underlying results that feed the plot
```{r}
departure <- flights %>%
  db_compute_raster(deptime, arrtime)
departure
```

2. Plot the results "manually"
```{r}
departure %>%
  filter(`n()` > 1000) %>%
  ggplot() +
  geom_raster(aes(x = deptime, y = arrtime, fill = `n()`))
```

## Under the hood (II)
*Review how `dbplot` pushes histogram and raster calculations to the database*

1. Use the `db_bin()` command to see the resulting tidy eval formula
```{r}
db_bin(field)
```

2. Use `translate_sql()` and `simulate_odbc_postgresql()` to see an example of what the resulting SQL statement looks like
```{r}
translate_sql(!! db_bin(field), con = simulate_odbc_postgresql())
```

3. Disconnect from the database

```{r}
dbDisconnect(con)
```

```{r, eval = TRUE, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE)
```
